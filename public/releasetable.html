<head>
  <title>PVSF システム部運営ツール 投稿予定表作成</title>
  <meta charset="UTF-8" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;900&family=Mrs+Saint+Delafield&family=Noto+Sans+JP:wght@300;500&family=Zen+Kaku+Gothic+New:wght@500&display=swap"
    rel="stylesheet"
  />
  <script>
    (function (d) {
      var config = {
          kitId: "qgy2nus",
          scriptTimeout: 3000,
          async: true,
        },
        h = d.documentElement,
        t = setTimeout(function () {
          h.className =
            h.className.replace(/\bwf-loading\b/g, "") + " wf-inactive";
        }, config.scriptTimeout),
        tk = d.createElement("script"),
        f = false,
        s = d.getElementsByTagName("script")[0],
        a;
      h.className += " wf-loading";
      tk.src = "https://use.typekit.net/" + config.kitId + ".js";
      tk.async = true;
      tk.onload = tk.onreadystatechange = function () {
        a = this.readyState;
        if (f || (a && a != "complete" && a != "loaded")) return;
        f = true;
        clearTimeout(t);
        try {
          Typekit.load(config);
        } catch (e) {}
      };
      s.parentNode.insertBefore(tk, s);
    })(document);
  </script>
</head>
<body>
  <div id="table">
    <div>
      <canvas id="btable" width="2880" height="3240"></canvas>
    </div>
    <div>
      <div>
        <canvas id="s1table" class="stable" width="3840" height="2160"></canvas>
      </div>
      <div>
        <canvas id="s2table" class="stable" width="3840" height="2160"></canvas>
      </div>
    </div>
  </div>
  <div id="testtext"></div>
  <div id="testtext1"></div>
  <div id="testtext2"></div>
  <div id="testtext3"></div>
</body>

<style>
  #table {
    display: flex;
    flex-wrap: wrap;
    width: 1950px;
  }
  #btable {
    width: 960px;
    height: 1080px;
    border: solid white 5px;
  }
  .stable {
    width: 960px;
    height: 540px;
    border: solid white 5px;
  }
</style>

<script type="text/javascript">
  $(function () {
    var databace =
      "https://script.google.com/macros/s/AKfycbw-S0MruPFNbv0Pqw18oCvIEQrtm_bDDsyz5yPCal9vhCNdd-pV7VmD1Gc7RzfYvctFxw/exec";
    $.getJSON(databace, (data) => {
      //"?p=(new Date()).getTime()"
      console.log(data[0].spread);
      var url = data[0].spread;
      var font = data[0].font;
      var tcolor = data[0].tcolor;
      var bcolor = data[0].bcolor;
      var ecolor = data[0].ecolor;
      $.getJSON(url, (plan) => {
        var planlong = Object.keys(plan).length;
        var dates = [];
        dates.push(plan[0].data);
        //日照会
        for (let i = 0; i < planlong; i++) {
          var dateslong = Object.keys(dates).length; //console.log(dates);
          //console.log(dateslong);
          for (let i2 = 0; i2 < dateslong; i2++) {
            if (plan[i].data == dates[i2]) {
            } else {
              dates.push(plan[i].data);
            }
          }
        }
        //分け目
        var btimecode = new Date(
          2023,
          plan[0].data.slice(0, 2),
          plan[0].data.slice(3, 5),
          plan[0].time.slice(0, 2),
          plan[0].time.slice(3, 5)
        );
        var difference = [];
        var maxdf = 0;
        var maxdfi = 0;
        var cutspot = 0;
        for (let i = 1; i < planlong; i++) {
          var timecode = new Date(
            2023,
            plan[i].data.slice(0, 2),
            plan[i].data.slice(3, 5),
            plan[i].time.slice(0, 2),
            plan[i].time.slice(3, 5)
          );
          console.log(timecode.toString());
          var df = (timecode - btimecode) / 60000;
          difference.push(df);
          if (maxdf < df) {
            var maxdf = df;
            var maxdfi = i;
          }
          console.log(difference);
          console.log(maxdf);
          console.log(maxdfi);
          var btimecode = new Date(
            2023,
            plan[i].data.slice(0, 2),
            plan[i].data.slice(3, 5),
            plan[i].time.slice(0, 2),
            plan[i].time.slice(3, 5)
          );
        }
        let indexedNumbers = difference.map((value, index) => ({
          value,
          index,
        }));
        indexedNumbers.sort((a, b) => b.value - a.value);
        let top4WithIndices = indexedNumbers.slice(0, 4);
        console.log(top4WithIndices);
        console.log(top4WithIndices[0].index + " " + planlong + "");
        if (
          Math.abs(top4WithIndices[0].index + 1) > planlong / 4 &&
          Math.abs(top4WithIndices[0].index + 1) < (planlong * 3) / 4
        ) {
          var cutspot = Math.abs(top4WithIndices[0].index);
        } else {
          console.log("誤差範囲外");
        }

        console.log(cutspot);
        if (cutspot + 1 < planlong - (cutspot + 1)) {
          var max = planlong - (cutspot + 1);
        } else {
          var max = cutspot + 1;
        }
        console.log("max " + max);
        let canvasb = document.querySelector("#btable");
        let contextb = canvasb.getContext("2d");
        let canvass1 = document.querySelector("#s1table");
        let contexts1 = canvass1.getContext("2d");
        let canvass2 = document.querySelector("#s2table");
        let contexts2 = canvass2.getContext("2d");

        contextb.beginPath();
        contextb.fillStyle = bcolor;
        contextb.fillRect(0, 0, canvasb.width, canvasb.height);
        contexts1.beginPath();
        contexts1.fillStyle = bcolor;
        contexts1.fillRect(0, 0, canvass1.width, canvass1.height);
        contexts2.beginPath();
        contexts2.fillStyle = bcolor;
        contexts2.fillRect(0, 0, canvass2.width, canvass2.height);

        var bwidth = 2680;
        var bheight = 2400;
        var bxstart = 100;
        var bystart = 370;
        var x = bxstart;
        var y = bystart;
        var ycutc = 2;
        for (let i = 0; i < planlong; i++) {
          contextb.fillStyle = tcolor;
          fz = bheight / max / 2;
          contextb.font = fz + "px '" + font + "'";
          contextb.textBaseline = "top";
          contextb.textAlign = "left";
          var y = y + bheight / max;
          contextb.fillText(
            plan[i].creator,
            x + (bheight / max) * 1,
            y + (bheight / max) * 0.3,
            bwidth / ycutc - (bheight / max)*1.2
          );
          var icon = plan[i].icon;
          var iconurl = "https://drive.google.com/uc?id=" + icon.slice(33);
          eval(
            "const icon" +
              i +
              " = new Image(); icon" +
              i +
              ".src = '" +
              iconurl +
              "'; icon" +
              i +
              ".onload = () => { contextb.drawImage(icon" +
              i +
              "," +
              (x) +
              "," +
              (y) +
              "," +
              (bheight / max) / 1.1 +
              "," +
              (bheight / max) / 1.1 +
              ");}"
          );
          if (i == cutspot) {
            var x = x + bwidth / ycutc;
            var y = bystart;
          }
        }
      });
    });
  });
</script>
